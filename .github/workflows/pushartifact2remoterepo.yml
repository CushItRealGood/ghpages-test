name: Add Artifact to a different Repo

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag'
        required: true

env:
  ARTIFACT_NAME: 'another-artifact.zip'
  ARTIFACT_FOLDER: 'appfolder'
  
jobs:
  download-artifact:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2
      with:
        repository: CushItRealGood/ghpages-test
        ref: main
        token: ${{ secrets.GHCR_TOKEN }}
        
    - name: Download Artifact
      run: |
        tag=${{ github.event.inputs.tag }}
        response=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/releases/tags/$tag")
        echo "GitHub API response: $response"
        asset_url=$(echo "$response" | jq -r '.assets[] | select(.name == "${{ env.ARTIFACT_NAME }}").browser_download_url')
        echo "Downloading artifact from URL: $asset_url"
        curl -sLJO -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$asset_url"

    - name: Push Artifact to Another Repo
      run: |
        mkdir -p gh-pages/${{ env.ARTIFACT_FOLDER }}/
        cp ${{ env.ARTIFACT_NAME }} gh-pages/${{ env.ARTIFACT_FOLDER }}/
        cd gh-pages/${{ env.ARTIFACT_FOLDER }}/
        base64 -w 0 ${{ env.ARTIFACT_NAME }} > encoded_artifact.txt
        curl -X PUT \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -d '{"message":"Add artifact to repository","committer":{"name":"GitHub Actions","email":"actions@github.com"},"content":"'$(cat encoded_artifact.txt)'"}' \
          "https://api.github.com/repos/CushItRealGood/gha/contents/main/${{ env.ARTIFACT_FOLDER }}/${{ env.ARTIFACT_NAME }}?ref=main"
